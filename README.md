# -*- coding: utf-8 -*-
"""Untitled7.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1gkDdR8Uld-JTsqn0dCHBqnXbBFsypR_p
"""

# Step 1: Install necessary libraries
!pip install ultralytics  # Install YOLOv8
!pip install matplotlib opencv-python-headless
!pip install roboflow

# Step 2: Import libraries
import matplotlib.pyplot as plt
from ultralytics import YOLO
from google.colab import files
import cv2
import numpy as np

!pip install roboflow

from roboflow import Roboflow
rf = Roboflow(api_key="lJ8SYVd246IVG28nlzVQ")
project = rf.workspace("uas-05rys").project("objek-hewan")
version = project.version(1)
dataset = version.download("yolov8")

import os

# Lihat folder tempat dataset diunduh
dataset_location = dataset.location  # dari RoboFlow download
print("Dataset downloaded to:", dataset_location)

import os
import yaml

# Muat file data.yaml
with open("/content/objek-hewan-1/data.yaml", "r") as f:
    data = yaml.safe_load(f)

# Perbarui path di file data.yaml
# Diasumsikan path 'train', 'val', dan 'test' relatif terhadap lokasi dataset
dataset_location = "/content/objek-hewan-1"  # Perbarui dengan lokasi dataset Anda

# **Corrected path updates:**
data["train"] = os.path.join(dataset_location, "train")  # Changed from data["train"]
data["val"] = os.path.join(dataset_location, "valid") # Changed from data["val"] and using "valid" instead of "val"
# Jika 'test' ada di data.yaml Anda, hapus komentar pada baris di bawah ini dan perbarui path-nya
# data["test"] = os.path.join(dataset_location, "test")

# Simpan file data.yaml yang telah diperbarui
with open("/content/objek-hewan-1/data.yaml", "w") as f:
    yaml.dump(data, f)

from ultralytics import YOLO

# Buat model YOLOv8 baru
model = YOLO("yolov8n.pt")  # "yolov8n.pt" adalah versi YOLOv8 Nano

# Jalankan pelatihan dengan dataset
model.train(data="/content/objek-hewan-1/data.yaml", epochs=10, imgsz=640)

dataset = version.download("yolov8")

result = model.predict(source="/content/images.jpg", save=True, imgsz=640)

# Ambil elemen pertama dari hasil prediksi
image_result = result[0]

# Menampilkan hasil deteksi
from IPython.display import Image, display
image_path_with_predictions = image_result.plot()  # Mengembalikan array gambar

# Tampilkan menggunakan Matplotlib
import matplotlib.pyplot as plt
plt.imshow(image_path_with_predictions)
plt.axis("off")
plt.show()

# Step 3: Upload image
uploaded = files.upload()
image_path = list(uploaded.keys())[0]

# Step 4: Load YOLO model
model = YOLO('yolov8n.pt')  # Use a pre-trained YOLOv8 model (nano version for speed)

# Step 5: Perform object detection
results = model(image_path)  # Run inference on the uploaded image

# Step 6: Visualize results
# Save the annotated image
annotated_img = results[0].plot()  # Create an annotated image (numpy array)

cv2.imwrite("runs/detect/predictions.jpg", annotated_img)

# Display the annotated image using matplotlib
plt.figure(figsize=(10, 10))
plt.imshow(cv2.cvtColor(annotated_img, cv2.COLOR_BGR2RGB))
plt.axis("off")
plt.title("YOLO Detected Objects")
plt.show()
